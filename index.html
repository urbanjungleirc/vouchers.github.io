<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urban Jungle - Gift Vouchers</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
    
    <!-- Bootstrap CSS -->
    <link href="https://tools.urbanjungleirc.com/assets/css/uj_colors_v2_blood_orange.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Configuration -->
    <script src="config.js"></script>
    
    <!-- Marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    
    <!-- PayPal SDK - will be loaded dynamically -->
    
    <!-- Google Tag Manager - will be loaded dynamically -->
    
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%);
        }
        
        .navbar { 
            border-bottom: 1px solid #eee; 
            backdrop-filter: blur(15px);
            background: rgba(255,255,255,0.95) !important;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        
        /* Enhanced Hero Section combining both designs */
        .hero-section {
            position: relative;
            background: linear-gradient(135deg, var(--bs-accent-dark) 0%, var(--bs-primary) 100%);
            color: white;
            padding: 3rem 0 2rem;
            margin-bottom: 0;
            overflow: hidden;
        }
        
        /* .hero-section::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,.6);
        } */
                
        .hero-section .container {
            position: relative;
            z-index: 3;
        }
        
        .hero-section h1 {
            font-size: 3.8rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            line-height: 1.1;
            transform: translateX(-30px);
            opacity: 0;
            animation: slideInLeft 1s ease 0.3s forwards;
        }
        
        .hero-section .lead {
            font-size: 1.4rem;
            margin-bottom: 2.5rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateX(-30px);
            animation: slideInLeft 1s ease 0.6s forwards;
        }
        
        .hero-image-container {
            transform: translateX(30px);
            opacity: 0;
            animation: slideInRight 1s ease 0.5s forwards;
        }
        
        @keyframes slideInLeft {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInRight {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .hero-cta {
            transform: translateX(-30px);
            opacity: 0;
            animation: slideInLeft 1s ease 0.9s forwards;
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 1.2rem 2.5rem;
            font-size: 1.2rem;
            font-weight: 600;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            transition: all 0.4s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .hero-cta:hover {
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.5);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        
        .hero-image-container {
            position: relative;
            overflow: hidden;
            border-radius: 20px;
            height: 400px;
            background: linear-gradient(135deg, rgba(231,76,60,0.1), rgba(231,76,60,0.3));
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            transition: all 0.6s ease;
        }
        
        .hero-image-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(231,76,60,0.2), rgba(231,76,60,0.4));
            opacity: 0;
            transition: opacity 0.4s ease;
            z-index: 2;
        }
        
        .hero-image-container:hover::before {
            opacity: 1;
        }
        
        .hero-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s ease, opacity 0.4s ease;
            opacity: 0;
        }
        
        .hero-image-container img.loaded {
            opacity: 1;
        }
        
        .hero-image-container:hover img {
            transform: scale(1.05);
        }
        
        .default-hero-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            z-index: 3;
            transition: opacity 0.4s ease;
        }
        
        .hero-image-container.has-image .default-hero-content {
            opacity: 0;
            pointer-events: none;
        }
                
        /* Enhanced Features Section */
        .features-section {
            padding: 5rem 0;
            /* background: white; */
            position: relative;
        }
        
        .features-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100px;
        }
        
        .feature-card {
            background: white;
            border-radius: 20px;
            padding: 2.5rem 2rem;
            text-align: center;
            height: 100%;
            border: none;
            box-shadow: 0 15px 40px rgba(0,0,0,0.08);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        
        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(231,76,60,0.05), transparent);
            transition: left 0.6s;
        }
        
        .feature-card:hover::before {
            left: 100%;
        }
        
        .feature-card:hover {
            transform: translateY(-12px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }
        
        .feature-card .bi {
            font-size: 3.5rem;
            color: var(--bs-primary);
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .feature-card:hover .bi {
            transform: scale(1.1);
        }
        
        .feature-card h5 {
            color: var(--bs-dark);
            margin-bottom: 1rem;
            font-weight: 700;
            font-size: 1.3rem;
        }
        
        /* Voucher Selection Enhancement */
        .voucher-selection {
            padding-bottom: 4rem;
            background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%);
        }
        
        .voucher-item {
            border: 2px solid #e9ecef;
            border-radius: 20px;
            transition: all 0.4s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background: white;
            height: 100%;
        }
        
        .voucher-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            transition: left 0.6s;
        }
        
        .voucher-item:hover::before {
            left: 100%;
        }
        
        .voucher-item:hover {
            border-color: var(--bs-primary);
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.12);
        }
        
        .voucher-item.selected {
            border-color: var(--bs-primary);
            /* background: linear-gradient(135deg, rgba(231,76,60,0.05), white); */
            box-shadow: 0 20px 40px rgba(231,76,60,0.15);
            transform: translateY(-8px);
        }
        
        .voucher-item.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .voucher-item.disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        .voucher-item.disabled::before {
            display: none;
        }
        
        .price-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--bs-primary);
        }
        
        .original-price {
            text-decoration: line-through;
            color: #6c757d;
            font-size: 1rem;
        }
        
        .discount-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 10px 18px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: bold;
            box-shadow: 0 8px 20px rgba(40,167,69,0.3);
            z-index: 2;
        }
        
        /* Enhanced Loading Experience */
        .loading-spinner {
            display: none;
            min-height: 85vh;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            position: relative;
        }
        
        .loading-content {
            max-width: 700px;
            margin: 0 auto;
            padding: 4rem 2rem;
        }
        
        .loading-main-spinner {
            width: 6rem;
            height: 6rem;
            border-width: 0.6rem;
            margin-bottom: 3rem;
        }
        
        .loading-progress {
            height: 15px;
            background: #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 3rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--bs-primary), var(--bs-secondary), var(--bs-primary));
            background-size: 200% 100%;
            border-radius: 8px;
            transition: width 0.8s ease;
            position: relative;
            overflow: hidden;
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .loading-stage {
            font-size: 1.3rem;
            color: var(--bs-dark);
            margin-bottom: 4rem;
            font-weight: 500;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading-features {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid #f8f9fa;
        }
        
        .loading-feature-item {
            padding: 1rem 0;
            border-bottom: 1px solid #f8f9fa;
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        
        .loading-feature-item:last-child {
            border-bottom: none;
        }
        
        .loading-feature-item:hover {
            background: #f8f9fa;
            padding-left: 1.5rem;
            transform: translateX(10px);
        }
        
        /* Purchase Summary Enhancement */
        .purchase-summary {
            background: white;
            border: none;
            border-radius: 25px;
            padding: 2.5rem;
            position: sticky;
            top: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.08);
            border: 2px solid #f8f9fa;
            transition: all 0.3s ease;
        }
        
        .purchase-summary.has-selection {
            border-color: var(--bs-primary);
            box-shadow: 0 25px 50px rgba(231,76,60,0.12);
        }
        
        @media (max-width: 991px) {
            .purchase-summary {
                position: static;
                margin-top: 3rem;
                top: auto;
            }
            
            .hero-section h1 {
                font-size: 2.8rem;
            }
            
            .hero-section .lead {
                font-size: 1.2rem;
            }
            
            .hero-image-container {
                height: 300px;
                margin-top: 2rem;
            }
            
            /* Adjust animations for mobile */
            .hero-section h1,
            .hero-section .lead,
            .hero-cta,
            .hero-image-container {
                animation: none;
                opacity: 1;
                transform: none;
            }
        }
        
        /* Form Enhancement */
        .form-card {
            background: white;
            border: none;
            border-radius: 25px;
            padding: 2.5rem;
            box-shadow: 0 15px 35px rgba(0,0,0,0.08);
            margin-bottom: 3rem;
            border: 1px solid #f8f9fa;
        }
        
        .form-label {
            font-weight: 700;
            color: var(--bs-dark);
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
        }
        
        .form-control {
            border-radius: 12px;
            border: 2px solid #e9ecef;
            padding: 1rem 1.2rem;
            transition: all 0.3s ease;
            font-size: 1.05rem;
        }
        
        .form-control:focus {
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 0.2rem rgba(231,76,60,0.15);
            transform: translateY(-2px);
        }
        
        /* Terms Section */
        .terms-section {
            /* background: white; */
            border-radius: 25px;
            padding: 2.5rem;
            box-shadow: 0 15px 35px rgba(0,0,0,0.08);
            border: 1px solid #f8f9fa;
        }
        
        /* Error and Success States */
        .error-message, .success-message {
            border-radius: 20px;
            padding: 3rem;
            margin: 3rem 1rem;
            border: none;
            text-align: center;
        }
        
        .error-message {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
        }
        
        .success-message {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
        }
        
        /* PayPal Container */
        .paypal-container {
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
            overflow: hidden;
        }
        
        /* Processing Spinner */
        .processing-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .processing-content {
            background: white;
            border-radius: 25px;
            padding: 4rem 3rem;
            text-align: center;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            margin: 2rem;
        }
        
        /* Icon System */
        .icon {
            display: inline-block;
            width: var(--icon-size, 2rem);
            height: var(--icon-size, 2rem);
            fill: currentColor;
            vertical-align: middle;
        }
        
        .feature-card {
            --icon-size: 3.5rem;
        }
        
        .hero h1 {
            --icon-size: 4rem;
        }
        
        /* Section Headers */
        .section-header {
            text-align: center;
            margin-bottom: 4rem;
        }
        
        .section-header h2 {
            font-size: 3rem;
            font-weight: 700;
            color: var(--bs-dark);
            margin-bottom: 1.5rem;
        }
        
        .section-header .lead {
            font-size: 1.3rem;
            color: #6c757d;
        }
        
        /* Limit Warning */
        .limit-warning {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid #ffc107;
            border-radius: 15px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        /* Form Validation */
        .form-validation-feedback {
            display: none;
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            font-weight: 500;
        }
        
        .form-validation-feedback.show {
            display: block;
        }
        
        /* Additional Enhancements */
        .navbar-brand {
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        /* Smooth animations */
        * {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--bs-secondary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--bs-accent-dark);
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) - will be loaded dynamically -->
    
    <!-- SVG Icons -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display:none;">
        <!-- 1. Carabiner (Hero) -->
        <symbol id="icon-carabiner" viewBox="0 0 24 24">
            <path d="M17.5 2.5a5 5 0 0 0-7.071 0L2.5 10.429a4.993 4.993 0 0 0 0 7.071 5 5 0 0 0 7.071 0l8.929-8.929a5 5 0 0 0 0-7.071zM7.929 17.071a3 3 0 0 1-4.243 0 3 3 0 0 1 0-4.243l8.929-8.929a3 3 0 0 1 4.243 0 3 3 0 0 1 0 4.243L7.929 17.071z"/>
            <circle cx="9" cy="9" r="2"/>
        </symbol>

        <!-- 2. Mountain (All Skill Levels) -->
        <symbol id="icon-mountain" viewBox="0 0 24 24">
            <path d="M2 18l8-14 6 10 4-6 4 10H2z"/>
        </symbol>

        <!-- 3. Belay Device (Thriving Community) -->
        <symbol id="icon-belay" viewBox="0 0 64 64">
            <path d="M32 2C17.64 2 6 13.64 6 28s11.64 26 26 26 26-11.64 26-26S46.36 2 32 2zm0 12a6 6 0 1 1 0 12 6 6 0 0 1 0-12zm0 30c-8.822 0-16-7.178-16-16s7.178-16 16-16 16 7.178 16 16-7.178 16-16 16z"/>
        </symbol>

        <!-- 4. Climbing Wall (All Disciplines) -->
        <symbol id="icon-wall" viewBox="0 0 24 24">
            <rect x="2" y="2" width="20" height="20" rx="2" ry="2"/>
            <circle cx="8" cy="8" r="1.5"/>
            <circle cx="16" cy="8" r="1.5"/>
            <circle cx="8" cy="16" r="1.5"/>
            <circle cx="16" cy="16" r="1.5"/>
            <circle cx="12" cy="12" r="1.5"/>
        </symbol>

        <!-- 5. Harness (Expert Coaching & Safety) -->
        <symbol id="icon-harness" viewBox="0 0 24 24">
            <path d="M12 2c-5 0-9 4-9 9v3c0 .552.448 1 1 1h2v2c0 .552.448 1 1 1h10c.552 0 1-.448 1-1v-2h2c.552 0 1-.448 1-1v-3c0-5-4-9-9-9zm7 13H5v-2h14v2z"/>
        </symbol>

        <!-- 6. Chalk Bag (Total Body & Mind Workout) -->
        <symbol id="icon-chalkbag" viewBox="0 0 24 24">
            <path d="M12 2c-1.105 0-2 .895-2 2v1H7c-1.105 0-2 .895-2 2v2h14V7c0-1.105-.895-2-2-2h-3V4c0-1.105-.895-2-2-2z"/>
            <path d="M4 12v6c0 1.105.895 2 2 2h12c1.105 0 2-.895 2-2v-6H4z"/>
        </symbol>

        <!-- 7. Rope Coil (Flexible Options) -->
        <symbol id="icon-rope" viewBox="0 0 24 24">
            <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8.009 8.009 0 0 1-8 8zM12 6a6 6 0 0 0-6 6h2a4 4 0 1 1 4 4v2a6 6 0 0 0 0-12z"/>
        </symbol>

        <!-- Ticket stub shape with punch hole -->
        <symbol id="icon-ticket" viewBox="0 0 24 24">
            <path d="M21 6H3a1 1 0 0 0-1 1v2a2 2 0 0 1 0 4v2a1 1 0 0 0 1 1h18a1 1 0 0 0 1-1v-2a2 2 0 0 1 0-4V7a1 1 0 0 0-1-1zm-9 9.5a1.5 1.5 0 1 1 1.5-1.5A1.5 1.5 0 0 1 12 15.5z"/>
        </symbol>

        <!-- Present -->
        <symbol id="icon-gift-box" viewBox="0 0 24 24">
            <!-- Box body -->
            <path d="M2 10h20v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V10z"/>
            <!-- Left bow loop -->
            <path d="M2 10V8a2 2 0 0 1 2-2h6v4H2z"/>
            <!-- Right bow loop -->
            <path d="M22 10V8a2 2 0 0 0-2-2h-6v4h8z"/>
            <!-- Ribbon lines -->
            <path d="M12 4v16"/>
            <path d="M2 10h20"/>
        </symbol>
    </svg>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="https://urbanjungleirc.com">
                <img src="https://tools.urbanjungleirc.com/assets/img/UrbanJungle-Logo_trans.png" alt="Urban Jungle" height="40" class="me-2">
                <span id="company-name">Urban Jungle IRC</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="https://urbanjungleirc.com">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://urbanjungleirc.com/findus">Contact</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Gift Vouchers</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h1 class="display-4 fw-bold mb-4" id="hero-title">
                        Gift the Thrill of Climbing
                    </h1>
                    <p class="lead mb-4" id="hero-description">
                        Urban Jungle gift vouchers: perfect for adventurers of every level.
                    </p>
                    <a href="#voucher-selection" class="hero-cta">
                        <i class="bi bi-gift"></i> Choose Your Adventure
                    </a>
                </div>
                <div class="col-lg-6">
                    <div class="hero-image-container" id="hero-image">
                        <img src="default_voucher_bg.png" 
                             alt="Urban Jungle Gift Voucher" 
                             class="hero-image default-image"
                             onerror="this.style.display='none'"
                             onload="this.classList.add('loaded')">
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Enhanced Loading State -->
    <div class="loading-spinner text-center">
        <div class="container">
            <div class="loading-content">
                <!-- Animated loading visualization -->
                <div class="mb-4">
                    <div class="d-flex justify-content-center mb-4">
                        <div class="spinner-border text-primary loading-main-spinner" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <h3 class="text-primary mb-3 fw-bold">Preparing Your Adventure Options</h3>
                    <div class="loading-progress mb-4">
                        <div class="loading-progress-bar" role="progressbar" style="width: 0%" id="loading-progress"></div>
                    </div>
                    <div id="loading-stage" class="loading-stage">
                        <p class="mb-2">üîç Finding the perfect climbing experiences for you...</p>
                    </div>
                </div>
                
                <!-- Urban Jungle brand messaging while loading -->
                <div class="loading-features">
                    <h5 class="text-primary mb-4 fw-bold">Why Choose Urban Jungle?</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="loading-feature-item d-flex align-items-center">
                                <i class="bi bi-check-circle text-primary me-3 fs-5"></i>
                                <span>Perth's premier indoor climbing facility</span>
                            </div>
                            <div class="loading-feature-item d-flex align-items-center">
                                <i class="bi bi-check-circle text-primary me-3 fs-5"></i>
                                <span>From first climb to pro level development</span>
                            </div>
                            <div class="loading-feature-item d-flex align-items-center">
                                <i class="bi bi-check-circle text-primary me-3 fs-5"></i>
                                <span>All Olympic disciplines under one roof</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="loading-feature-item d-flex align-items-center">
                                <i class="bi bi-check-circle text-primary me-3 fs-5"></i>
                                <span>Expert coaching & premium safety gear</span>
                            </div>
                            <div class="loading-feature-item d-flex align-items-center">
                                <i class="bi bi-check-circle text-primary me-3 fs-5"></i>
                                <span>Gift vouchers perfect for any occasion</span>
                            </div>
                            <div class="loading-feature-item d-flex align-items-center">
                                <i class="bi bi-check-circle text-primary me-3 fs-5"></i>
                                <span>Flexible redemption and no expiry stress</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Error State -->
    <div class="error-message" style="display: none;">
        <h4><i class="bi bi-exclamation-triangle"></i> Error Loading Vouchers</h4>
        <p id="error-text">Sorry, we couldn't load the voucher options. Please try again later.</p>
        <button class="btn btn-outline-danger btn-lg" onclick="location.reload()">
            <i class="bi bi-arrow-clockwise"></i> Try Again
        </button>
    </div>
    
    <!-- Main Content -->
    <div class="container">
        <!-- Voucher Selection -->
        <div id="voucher-content" style="display: none;">
            
            <!-- Enhanced Features Section -->
            <section class="features-section">
                <div class="section-header">
                    <h2>Perfect Gifts for Every Climber</h2>
                    <p class="lead">Give the gift of adventure with our flexible voucher options</p>
                </div>
                
                <div class="row g-4 mb-5">
                    <div class="col-md-4">
                        <div class="feature-card">
                            <svg class="icon text-primary mb-3"><use href="#icon-mountain"></use></svg>
                            <h5>All Skill Levels</h5>
                            <p>From nervous first-timers to seasoned pros seeking their next challenge.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="feature-card">
                            <svg class="icon text-primary mb-3"><use href="#icon-belay"/></svg>
                            <h5>Thriving Community</h5>
                            <p>Connect with fellow climbers and become part of Perth's most welcoming climbing family.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="feature-card">
                            <svg class="icon text-primary mb-3"><use href="#icon-wall"/></svg>
                            <h5>All Disciplines</h5>
                            <p>Lead, boulder, speed & top‚Äërope climbing in one purpose‚Äëbuilt facility.</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <div class="voucher-selection" id="voucher-selection">
                <div class="row">
                    <div class="col-lg-8">
                        <!-- Voucher Items -->
                        <div class="form-card">
                            <h3 class="mb-4"><i class="bi bi-gift"></i> Select Your Voucher</h3>
                            <div class="row g-4" id="voucher-items">
                                <!-- Voucher items will be loaded here -->
                            </div>
                        </div>
                        
                        <!-- Customer Details -->
                        <div class="form-card">
                            <h3 class="mb-4">
                                <i class="bi bi-person"></i> Your Details
                            </h3>
                            <form id="customer-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="customer-name" class="form-label">Full Name *</label>
                                            <input type="text" class="form-control" id="customer-name" required>
                                            <div class="form-validation-feedback" id="customer-name-feedback"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="customer-email" class="form-label">Email Address *</label>
                                            <input type="email" class="form-control" id="customer-email" required>
                                            <div class="form-text">Voucher will be sent to this email</div>
                                            <div class="form-validation-feedback" id="customer-email-feedback"></div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Gift Information Row -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="gift-from" class="form-label">Gift From (optional)</label>
                                            <input type="text" class="form-control" id="gift-from" placeholder="e.g., Mum & Dad, The Smith Family" maxlength="80">
                                            <div class="form-text">Who is giving this gift? (max 80 characters)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="gift-recipient" class="form-label">Gift To (optional)</label>
                                            <input type="text" class="form-control" id="gift-recipient" placeholder="Recipient's name" maxlength="80">
                                            <div class="form-text">Who is receiving this gift? (max 80 characters)</div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Gift Message Row -->
                                <div class="mb-3">
                                    <label for="gift-message" class="form-label">Gift Message (optional)</label>
                                    <textarea class="form-control" id="gift-message" rows="3" placeholder="Add a personal message..." maxlength="170"></textarea>
                                    <div class="form-text">Maximum 170 characters - perfect for a heartfelt note!</div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <!-- Purchase Summary -->
                        <div class="purchase-summary" id="purchase-summary">
                            <h4 class="mb-3">
                                <i class="bi bi-cart-check"></i> Purchase Summary
                            </h4>
                            <div id="summary-content">
                                <div class="text-muted text-center py-4">
                                    <i class="bi bi-arrow-left fs-3 mb-3 d-block"></i>
                                    <p class="mb-0">Please select a voucher option to see pricing</p>
                                </div>
                            </div>
                            
                            <!-- PayPal Button Container -->
                            <div id="paypal-button-container" class="paypal-container mt-3" style="display: none;">
                                <!-- PayPal button will be rendered here -->
                            </div>
                        </div>
                        
                        <!-- Purchase Limit Warning -->
                        <div id="limit-warning" class="limit-warning mt-5" style="display: none !important;">
                            <i class="bi bi-info-circle fs-4 text-warning me-2"></i>
                            <div>
                                <strong>Purchase Limit:</strong> <span id="limit-text"></span>
                            </div>
                        </div>

                        <!-- Terms and Conditions -->
                        <div class="terms-section mt-5">
                            <h4><i class="bi bi-info-circle"></i> Terms and Conditions</h4>
                            <div id="terms-content" class="mt-3">
                                <!-- Terms will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Success Message -->
        <div class="success-message" style="display: none;">
            <h4><i class="bi bi-check-circle"></i> Purchase Successful!</h4>
            <p>Thank you for your purchase! Your voucher will be sent to your email address <span id="success-email"></span> <strong>within 15 minutes</strong>.</p>
            <div class="mt-3">
                <button class="btn btn-success btn-lg" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Purchase Another
                </button>
                <button class="btn btn-lg me-2" onclick="location.href='https://urbanjungleirc.com'">
                    <i class="bi bi-house"></i> Back to Home
                </button>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer style="background: #222; color: #bbb;" class="text-center py-5 px-3 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <p class="mb-3">Urban Jungle IRC &copy; <span id="copyright3">
                        <script>document.getElementById('copyright3').appendChild(document.createTextNode(new Date().getFullYear()))</script>
                    </span></p>
                    
                    <!-- Social Media Links -->
                    <div class="d-flex justify-content-center gap-3 mb-3">
                        <a href="https://www.facebook.com/UrbanJungleIRC" target="_blank" style="color: #bbb; font-size: 1.5rem;" title="Follow us on Facebook">
                            <i class="bi bi-facebook"></i>
                        </a>
                        <a href="https://www.instagram.com/urbanjungleirc" target="_blank" style="color: #bbb; font-size: 1.5rem;" title="Follow us on Instagram">
                            <i class="bi bi-instagram"></i>
                        </a>
                        <a href="https://www.youtube.com/@urbanjungleirc" target="_blank" style="color: #bbb; font-size: 1.5rem;" title="Subscribe to our YouTube">
                            <i class="bi bi-youtube"></i>
                        </a>
                    </div>
                    
                    <small>83 Solomon Rd, Jandakot WA 6164 | (08) 6397 0411 | <a href="mailto:admin@urbanjungleirc.com" style="color: #bbb;">admin@urbanjungleirc.com</a></small>
                    <p class="my-0"><small>3.22.4 - i08</small></p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap Alert Modal -->
    <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alertModalLabel">
                        <i class="bi bi-exclamation-triangle"></i> Alert
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="alertModalMessage">Message content will appear here.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Processing Spinner -->
    <div id="processing-spinner" class="processing-spinner">
        <div class="processing-content">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Processing...</span>
            </div>
            <h4 class="text-primary">Processing Payment...</h4>
            <p class="text-muted mb-0">This may take up to 60 seconds. Please wait.</p>
            <small class="text-muted d-block mt-2">Do not close this window or press back.</small>
        </div>
    </div>

    <!-- Test Mode Panel (Hidden by default, activated with ?test=true) -->
    <div id="test-mode-panel" style="display:none; position:fixed; bottom:20px; right:20px; background:#fff; border:3px solid #ff6b6b; border-radius:8px; padding:15px; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index:9999; max-width:300px;">
        <h5 style="color:#ff6b6b; margin:0 0 10px 0;">üß™ TEST MODE</h5>
        <p style="font-size:12px; margin-bottom:10px;">Simulate PayPal flow without real payments</p>
        <button onclick="window.testDuplicatePrevention()" class="btn btn-sm btn-danger mb-2 w-100">Test Duplicate Click</button>
        <button onclick="window.testRapidClicks()" class="btn btn-sm btn-warning mb-2 w-100">Test Rapid Clicks (3x)</button>
        <button onclick="window.testLocalStorageCheck()" class="btn btn-sm btn-info mb-2 w-100">Test localStorage Check</button>
        <button onclick="window.clearTestState()" class="btn btn-sm btn-secondary w-100">Clear Test State</button>
        <div id="test-results" style="margin-top:10px; font-size:11px; color:#666;"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
    
    <!-- Custom JavaScript (Complete functionality from original) -->
    <script>
        // Bootstrap Alert Function
        function showBootstrapAlert(message, title = 'Alert', type = 'warning') {
            const alertModal = document.getElementById('alertModal');
            const alertTitle = document.getElementById('alertModalLabel');
            const alertMessage = document.getElementById('alertModalMessage');
            
            // Update modal content
            alertTitle.innerHTML = `<i class="bi bi-${type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i> ${title}`;
            alertMessage.textContent = message;
            
            // Show modal
            const modal = new bootstrap.Modal(alertModal);
            modal.show();
        }
        
        // Bootstrap Alert Function with HTML support
        function showBootstrapAlertHtml(htmlMessage, title = 'Alert', type = 'warning') {
            const alertModal = document.getElementById('alertModal');
            const alertTitle = document.getElementById('alertModalLabel');
            const alertMessage = document.getElementById('alertModalMessage');
            
            // Update modal content
            alertTitle.innerHTML = `<i class="bi bi-${type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i> ${title}`;
            alertMessage.innerHTML = htmlMessage;
            
            // Show modal
            const modal = new bootstrap.Modal(alertModal);
            modal.show();
        }
        
        // Configuration is loaded from config.js
        // Ensure CONFIG is available
        
        // Global variables
        let voucherType = null;
        let voucherItems = [];
        let selectedItem = null;
        let purchaseLimit = null;

        // Purchase processing configuration
        const PURCHASE_CONFIG = {
            INITIAL_TIMEOUT: 60000,        // 60 seconds (doubled from 30s)
            RETRY_TIMEOUTS: [75000, 90000], // Progressive timeouts: 75s, 90s
            MAX_RETRIES: 2,                // Total: 3 attempts (1 initial + 2 retries)
            RETRY_DELAY: 2000,             // 2 second delay between retries
            STORAGE_KEY: 'ujPayPalOrder',  // localStorage key for tracking
            STORAGE_TTL: 3600000           // 1 hour TTL for localStorage
        };

        // Track processed PayPal orders in memory (prevents rapid duplicates)
        const processedPayPalOrders = new Set();

        // DOM element cache for performance
        const DOM = {
            loadingSpinner: null,
            errorMessage: null,
            voucherContent: null,
            voucherItems: null,
            summaryContent: null,
            paypalContainer: null,
            purchaseSummary: null,
            processingSpinner: null,
            customerForm: null,
            customerName: null,
            customerEmail: null,
            giftRecipient: null,
            giftFrom: null,
            giftMessage: null,
            successMessage: null,
            successEmail: null,
            
            // Initialize DOM cache
            init: function() {
                this.loadingSpinner = document.querySelector('.loading-spinner');
                this.errorMessage = document.querySelector('.error-message');
                this.voucherContent = document.getElementById('voucher-content');
                this.voucherItems = document.getElementById('voucher-items');
                this.summaryContent = document.getElementById('summary-content');
                this.paypalContainer = document.getElementById('paypal-button-container');
                this.purchaseSummary = document.getElementById('purchase-summary');
                this.processingSpinner = document.getElementById('processing-spinner');
                this.customerForm = document.getElementById('customer-form');
                this.customerName = document.getElementById('customer-name');
                this.customerEmail = document.getElementById('customer-email');
                this.giftRecipient = document.getElementById('gift-recipient');
                this.giftFrom = document.getElementById('gift-from');
                this.giftMessage = document.getElementById('gift-message');
                this.successMessage = document.querySelector('.success-message');
                this.successEmail = document.getElementById('success-email');
            }
        };

        // LocalStorage management for order tracking (prevents duplicate vouchers)
        const OrderStorage = {
            save(orderData) {
                try {
                    const data = {
                        ...orderData,
                        timestamp: Date.now(),
                        expiresAt: Date.now() + PURCHASE_CONFIG.STORAGE_TTL
                    };
                    localStorage.setItem(PURCHASE_CONFIG.STORAGE_KEY, JSON.stringify(data));
                } catch (e) {
                    console.warn('Failed to save order to localStorage:', e);
                }
            },

            get() {
                try {
                    const data = localStorage.getItem(PURCHASE_CONFIG.STORAGE_KEY);
                    if (!data) return null;

                    const parsed = JSON.parse(data);

                    // Check if expired
                    if (parsed.expiresAt && Date.now() > parsed.expiresAt) {
                        this.clear();
                        return null;
                    }

                    return parsed;
                } catch (e) {
                    console.warn('Failed to read order from localStorage:', e);
                    return null;
                }
            },

            clear() {
                try {
                    localStorage.removeItem(PURCHASE_CONFIG.STORAGE_KEY);
                } catch (e) {
                    console.warn('Failed to clear order from localStorage:', e);
                }
            },

            exists(orderId) {
                const data = this.get();
                return data && data.orderId === orderId;
            }
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        // Check for pending order on page load
        function checkPendingOrder() {
            const pendingOrder = OrderStorage.get();
            if (pendingOrder && pendingOrder.status === 'processing') {
                showBootstrapAlert(
                    `We're still processing your recent order (${pendingOrder.orderId}).\n\n` +
                    `Your voucher will be sent to ${pendingOrder.email} within 15 minutes.\n\n` +
                    `If you don't receive it, please contact us with your order ID.`,
                    'Order in Progress',
                    'info'
                );

                OrderStorage.clear();
            }
        }

        // Initialize application
        function initializeApp() {
            // Initialize DOM cache first
            DOM.init();

            // Check for pending orders from previous session
            checkPendingOrder();

            // Clear any stale in-memory order tracking on page load
            processedPayPalOrders.clear();

            // Setup event listeners
            setupFormValidation();
            setupEventListeners();

            // Load external scripts
            loadAnalytics();
            loadPayPalSDK();

            // Initialize page
            loadVoucherData();
        }
        
        // Load analytics
        function loadAnalytics() {
            if (CONFIG.FEATURES.ENABLE_ANALYTICS && CONFIG.ANALYTICS.GTM_ID !== 'GTM-XXXXXXX') {
                // Load Google Tag Manager
                const gtmScript = document.createElement('script');
                gtmScript.async = true;
                gtmScript.src = `https://www.googletagmanager.com/gtm.js?id=${CONFIG.ANALYTICS.GTM_ID}`;
                document.head.appendChild(gtmScript);
                
                // Initialize dataLayer
                window.dataLayer = window.dataLayer || [];
                window.dataLayer.push({
                    'gtm.start': new Date().getTime(),
                    'event': 'gtm.js'
                });
                
                // Add noscript fallback
                const noscript = document.createElement('noscript');
                noscript.innerHTML = `<iframe src="https://www.googletagmanager.com/ns.html?id=${CONFIG.ANALYTICS.GTM_ID}" height="0" width="0" style="display:none;visibility:hidden"></iframe>`;
                document.body.insertBefore(noscript, document.body.firstChild);
            }
            
            if (CONFIG.FEATURES.ENABLE_FACEBOOK_PIXEL && CONFIG.ANALYTICS.FB_PIXEL_ID !== 'XXXXXXXXXXXXXXX') {
                // Load Facebook Pixel
                const fbScript = document.createElement('script');
                fbScript.innerHTML = `
                    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
                    n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
                    n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
                    t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
                    document,'script','https://connect.facebook.net/en_US/fbevents.js');
                    fbq('init', '${CONFIG.ANALYTICS.FB_PIXEL_ID}');
                    fbq('track', 'PageView');
                `;
                document.head.appendChild(fbScript);
            }
        }
        
        // Load PayPal SDK with deduplication
        function loadPayPalSDK() {
            if (CONFIG.PAYPAL.CLIENT_ID !== 'YOUR_PAYPAL_CLIENT_ID' && !window.paypalSDKLoaded) {
                window.paypalSDKLoaded = true;
                const paypalScript = document.createElement('script');
                paypalScript.src = `https://www.paypal.com/sdk/js?client-id=${CONFIG.PAYPAL.CLIENT_ID}&currency=${CONFIG.PAYPAL.CURRENCY}`;
                paypalScript.onload = function() {
                    window.paypalSDKReady = true;
                };
                paypalScript.onerror = function() {
                    window.paypalSDKLoaded = false;
                };
                document.head.appendChild(paypalScript);
            }
        }
        
        // Unified API request function with caching and error handling
        const ApiClient = {
            cache: new Map(),
            
            async makeRequest(url, options = {}) {
                const cacheKey = url + JSON.stringify(options);
                const cacheTTL = options.cacheTTL || 0; // Default no cache
                
                // Check cache first
                if (cacheTTL > 0 && this.cache.has(cacheKey)) {
                    const cached = this.cache.get(cacheKey);
                    if (Date.now() - cached.timestamp < cacheTTL) {
                        return cached.data;
                    }
                    this.cache.delete(cacheKey);
                }
                
                // Make the request with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), options.timeout || 30000);
                
                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        mode: 'cors',
                        credentials: 'omit',
                        signal: controller.signal,
                        ...options
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const text = await response.text();
                    let result;
                    
                    // Parse response (handles both JSONP and regular JSON)
                    const jsonpMatch = text.match(/\w+\((.*)\);?$/);
                    if (jsonpMatch) {
                        result = JSON.parse(jsonpMatch[1]);
                    } else {
                        result = JSON.parse(text);
                    }
                    
                    // Cache the result if cacheTTL is set
                    if (cacheTTL > 0) {
                        this.cache.set(cacheKey, {
                            data: result,
                            timestamp: Date.now()
                        });
                    }
                    
                    return result;
                    
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error('Request timed out');
                    }
                    throw error;
                }
            }
        };
        
        // Load voucher data based on promo_id or fallback to default
        function loadVoucherData() {
            const urlParams = new URLSearchParams(window.location.search);
            const promoId = urlParams.get('promoID');
            
            if (!promoId) {
                // No promoID provided - fallback to first available voucher type
                loadDefaultVoucherType();
                return;
            }
            
            // PromoID provided - use specific voucher type
            loadVoucherDataByPromoId(promoId);
        }
        
        
        // Load default voucher type (first available)
        async function loadDefaultVoucherType() {
            showLoading();
            
            try {
                const apiUrl = `${CONFIG.API_BASE_URL}?action=getDefaultCustomerVoucherData`;
                const data = await ApiClient.makeRequest(apiUrl, { cacheTTL: 60000 }); // Cache for 1 minute
                handleVoucherDataSuccess(data, true);
            } catch (error) {
                handleDefaultVoucherError(error);
            }
        }
        
        // Load voucher data for specific promo ID
        async function loadVoucherDataByPromoId(promoId) {
            showLoading();
            
            try {
                const apiUrl = `${CONFIG.API_BASE_URL}?action=getCustomerVoucherData&promoId=${promoId}`;
                const data = await ApiClient.makeRequest(apiUrl, { cacheTTL: 300000 }); // Cache for 5 minutes
                handleVoucherDataSuccess(data, false);
            } catch (error) {
                handleVoucherDataError(error);
            }
        }
        
        // Handle successful voucher data loading
        function handleVoucherDataSuccess(data, isDefault = false) {
            hideLoading();
            
            if (!data || !data.success) {
                if (isDefault) {
                    handleDefaultVoucherError(new Error(data ? data.error : 'No voucher types available'));
                } else {
                    showError(data ? data.error : 'Failed to load voucher data. Please check your link and try again.');
                }
                return;
            }
            
            voucherType = data.voucherType;
            voucherItems = data.voucherItems || [];
            purchaseLimit = data.purchaseLimit;
            
            // Update page content
            updateHeroSection(isDefault);
            displayVoucherItems();
            displayPurchaseLimit();
            displayTermsAndConditions();
            
            
            // Show main content
            DOM.voucherContent.style.display = 'block';
            
            // Initialize PayPal
            initializePayPal();
        }
        
        // Handle default voucher loading error
        function handleDefaultVoucherError(error) {
            hideLoading();
            
            // Create HTML formatted error message for proper display
            const errorMessageHtml = `
                <div class="text-center">
                    <h4 class="mb-4">Welcome to Urban Jungle Gift Vouchers!</h4>
                    <p class="mb-4">We're currently setting up our voucher system. Please contact us directly to purchase gift vouchers:</p>
                    
                    <div class="contact-info mb-4">
                        <div class="mb-2"><strong>üìû Phone:</strong> (08) 6397 0411</div>
                        <div class="mb-2"><strong>üìß Email:</strong> frontdesk@urbanjungleirc.com</div>
                        <div class="mb-2"><strong>üè¢ Visit:</strong> 83 Solomon Rd, Jandakot WA 6164</div>
                    </div>
                    
                    <p class="text-muted">We apologize for any inconvenience.</p>
                    
                </div>
            `;
            
            showErrorHtml(errorMessageHtml);
        }
        
        
        // Handle voucher data loading error
        function handleVoucherDataError(error) {
            hideLoading();
            
            let errorMessage = 'Failed to load voucher data. ';
            
            if (error.message && error.message.includes('Failed to fetch')) {
                errorMessage += 'This could be due to:\n' +
                    '‚Ä¢ Google Apps Script not deployed properly\n' +
                    '‚Ä¢ CORS issues with the API\n' +
                    '‚Ä¢ Network connectivity problems\n' +
                    '‚Ä¢ Incorrect API URL in config.js\n\n' +
                    'Please check the console for more details.';
            } else {
                errorMessage += error.message || 'Unknown error occurred.';
            }
            
            showError(errorMessage);
        }
        
        // Update hero section with voucher type data
        function updateHeroSection(isDefault = false) {
            if (voucherType) {
                // Update hero title and description
                let titleText = voucherType.display_name || 'Gift Vouchers';
                
                // Add subtle indication for default voucher
                if (isDefault) {
                    document.getElementById('hero-title').innerHTML = titleText;
                } else {
                    document.getElementById('hero-title').innerHTML = titleText;
                }
                
                if (voucherType.description) {
                    document.getElementById('hero-description').textContent = voucherType.description;
                } else if (isDefault) {
                    // Provide a default description for general vouchers
                    document.getElementById('hero-description').textContent = 
                        'Urban Jungle gift vouchers: perfect for adventurers of every level. Give the gift that takes them to new heights.';
                }
                
                // Update page title
                const pageTitle = isDefault ? 
                    `${titleText} - Urban Jungle IRC` : 
                    `${titleText} - Urban Jungle IRC`;
                document.title = pageTitle;
                
                // Update hero image - support for promo images
                updateHeroImage();
            }
        }
        
        // Update hero image with promo image support
        function updateHeroImage() {
            const heroContainer = document.getElementById('hero-image');
            const defaultImage = heroContainer.querySelector('.default-image');
            const defaultContent = heroContainer.querySelector('.default-hero-content');
            
            // Check if voucher type has a promo image URL
            if (voucherType && voucherType.promo_image_url && voucherType.promo_image_url.trim()) {
                // Create new promo image
                const promoImage = document.createElement('img');
                promoImage.src = voucherType.promo_image_url;
                promoImage.alt = voucherType.display_name || 'Voucher';
                promoImage.className = 'hero-image promo-image';
                promoImage.style.zIndex = '4';
                
                // Handle successful promo image load
                promoImage.onload = function() {
                    this.classList.add('loaded');
                    heroContainer.classList.add('has-image');
                    // Fade out default image
                    if (defaultImage) {
                        defaultImage.style.opacity = '0';
                    }
                };
                
                // Handle promo image error - fallback to default
                promoImage.onerror = function() {
                    this.remove();
                    heroContainer.classList.remove('has-image');
                    // Ensure default content is visible
                    if (defaultContent) {
                        defaultContent.style.opacity = '1';
                    }
                };
                
                // Add promo image to container
                heroContainer.appendChild(promoImage);
            } else {
                // No promo image, ensure default content is visible
                heroContainer.classList.remove('has-image');
                if (defaultContent) {
                    defaultContent.style.opacity = '1';
                }
            }
            
        }
        
        // Display voucher items
        function displayVoucherItems() {
            DOM.voucherItems.innerHTML = '';
            
            if (!voucherItems || voucherItems.length === 0) {
                DOM.voucherItems.innerHTML = '<div class="col-12"><p class="text-muted">No voucher options available at this time.</p></div>';
                return;
            }
            
            voucherItems.forEach(item => {
                const isDisabled = !item.is_active;
                const discountPercent = item.discount_percent || 0;
                const originalPrice = parseFloat(item.value) || 0;
                const discountedPrice = originalPrice * (1 - discountPercent / 100);
                
                const itemHtml = `
                    <div class="col-md-6 col-xl-4 mb-4">
                        <div class="voucher-item ${isDisabled ? 'disabled' : ''}" 
                             data-item-id="${item.id}" 
                             ${isDisabled ? '' : 'onclick="selectVoucherItem(this)"'}>
                            
                            ${discountPercent > 0 ? `<div class="discount-badge">${discountPercent}% OFF</div>` : ''}
                            
                            <div class="p-4">
                                <h5 class="mb-3 fw-bold">${item.name}</h5>
                                ${item.description ? `<p class="text-muted mb-4" style="line-height: 1.6;">${item.description}</p>` : ''}
                                
                                <div class="price-display mb-3">
                                    ${discountPercent > 0 ? `
                                        <div class="original-price mb-1">$${originalPrice.toFixed(2)}</div>
                                        <div class="text-success">$${discountedPrice.toFixed(2)}</div>
                                    ` : `
                                        $${originalPrice.toFixed(2)}
                                    `}
                                </div>
                                
                                ${isDisabled ? 
                                    '<div class="text-muted mt-3"><small>Currently unavailable</small></div>' : 
                                    '<div class="text-success mt-3"><small><i class="bi bi-check-circle"></i> Available</small></div>'
                                }
                            </div>
                        </div>
                    </div>
                `;
                
                DOM.voucherItems.innerHTML += itemHtml;
            });
        }
        
        // Display purchase limit information
        function displayPurchaseLimit() {
            const limitWarning = document.getElementById('limit-warning');
            const limitText = document.getElementById('limit-text');
                        
            if (!limitWarning || !limitText) {
                console.error('Warning elements not found!');
                return;
            }
            
            if (purchaseLimit && purchaseLimit.limitType !== 'unlimited') {
                
                // Clear any existing content first
                limitText.textContent = '';
                limitText.innerHTML = '';
                
                // Set the content
                limitText.textContent = purchaseLimit.description;
                
                // Force visibility (remove the !important inline style and set display)
                limitWarning.style.setProperty('display', 'flex', 'important');
                limitWarning.style.visibility = 'visible';
                limitWarning.style.opacity = '1';
                
            } else {
                limitWarning.style.display = 'none';
            }
        }
        
        // Select voucher item
        function selectVoucherItem(element) {
            // Remove previous selection
            document.querySelectorAll('.voucher-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selection to current item
            element.classList.add('selected');
            
            // Get selected item data
            const itemId = element.dataset.itemId;
            selectedItem = voucherItems.find(item => item.id === itemId);
            
            // Update purchase summary
            updatePurchaseSummary();
            
            // Clear form validation errors
            clearFormValidation();
        }
        
        // Update purchase summary
        function updatePurchaseSummary() {
            
            if (!selectedItem) {
                DOM.summaryContent.innerHTML = `
                    <div class="text-muted text-center py-4">
                        <i class="bi bi-arrow-left fs-3 mb-3 d-block"></i>
                        <p class="mb-0">Please select a voucher option to see pricing</p>
                    </div>
                `;
                DOM.paypalContainer.style.display = 'none';
                DOM.purchaseSummary.classList.remove('has-selection');
                return;
            }
            
            const discountPercent = selectedItem.discount_percent || 0;
            const originalPrice = parseFloat(selectedItem.value) || 0;
            const discountedPrice = originalPrice * (1 - discountPercent / 100);
            
            const summaryHtml = `
                <div class="d-flex justify-content-between mb-2">
                    <span class="fw-bold">${selectedItem.name}</span>
                    <span class="fw-bold">$${originalPrice.toFixed(2)}</span>
                </div>
                ${discountPercent > 0 ? `
                    <div class="d-flex justify-content-between mb-2 text-success">
                        <span>Discount (${discountPercent}%)</span>
                        <span>-$${(originalPrice - discountedPrice).toFixed(2)}</span>
                    </div>
                ` : ''}
                <hr>
                <div class="d-flex justify-content-between fw-bold fs-4 text-primary">
                    <span>Total</span>
                    <span>$${discountedPrice.toFixed(2)} AUD</span>
                </div>
                <div class="text-center mt-3">
                    <small class="text-muted">
                        <i class="bi bi-shield-check"></i> Secure payment ‚Ä¢ <i class="bi bi-envelope"></i> Digital delivery within 15 minutes
                    </small>
                </div>
            `;
            
            DOM.summaryContent.innerHTML = summaryHtml;
            DOM.paypalContainer.style.display = 'block';
            DOM.purchaseSummary.classList.add('has-selection');
        }
        
        // Display terms and conditions
        function displayTermsAndConditions() {
            const container = document.getElementById('terms-content');
            
            if (voucherType && voucherType.terms_conditions) {
                // Parse markdown to HTML using marked.js (if available) or basic conversion
                let htmlContent;
                
                if (typeof marked !== 'undefined') {
                    // Use marked.js for proper markdown parsing
                    htmlContent = marked.parse(voucherType.terms_conditions);
                } else {
                    // Basic markdown to HTML conversion with proper heading levels
                    const terms = voucherType.terms_conditions
                        .replace(/^### (.*$)/gm, '<h6>$1</h6>')  // h3 -> h6
                        .replace(/^## (.*$)/gm, '<h5>$1</h5>')   // h2 -> h5  
                        .replace(/^# (.*$)/gm, '<h5>$1</h5>')    // h1 -> h5
                        .replace(/\n\n/g, '</p><p>')
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>')
                        .replace(/^- (.*$)/gm, '<li>$1</li>');
                    
                    htmlContent = `<p>${terms}</p>`;
                }
                
                // Process HTML content to fix headings and remove duplicate titles
                htmlContent = processTermsContent(htmlContent);
                
                container.innerHTML = htmlContent;
            } else {
                container.innerHTML = `
                    <p>Standard voucher terms and conditions apply:</p>
                    <ul>
                        <li>Vouchers are valid for 36 months from date of purchase</li>
                        <li>Vouchers are non-refundable but can be used for multiple visits</li>
                        <li>Valid for all climbing activities and equipment hire</li>
                        <li>Present voucher at reception for redemption</li>
                    </ul>
                `;
            }
        }
        
        // Process terms content to handle titles and heading levels
        function processTermsContent(htmlContent) {
            // Create a temporary div to parse HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            
            // Remove any existing "Terms and Conditions" titles
            const headings = tempDiv.querySelectorAll('h1, h2, h3, h4, h5, h6');
            headings.forEach(heading => {
                const text = heading.textContent.toLowerCase().trim();
                if (text.includes('terms and conditions') || text.includes('terms & conditions')) {
                    heading.remove();
                }
            });
            
            // Downgrade all heading levels (since we have fixed h4 title)
            // h1 -> h5, h2 -> h5, h3 -> h6, h4 -> h6, h5 -> h6, h6 -> h6
            const headingMap = {
                'H1': 'h6',
                'H2': 'h6', 
                'H3': 'h6',
                'H4': 'h6',
                'H5': 'h6',
                'H6': 'h6'
            };
            
            // Get updated headings list after removal
            const allHeadings = tempDiv.querySelectorAll('h1, h2, h3, h4, h5, h6');
            allHeadings.forEach(heading => {
                const newTagName = headingMap[heading.tagName];
                if (newTagName && newTagName !== heading.tagName.toLowerCase()) {
                    const newHeading = document.createElement(newTagName);
                    newHeading.innerHTML = heading.innerHTML;
                    newHeading.className = heading.className;
                    heading.parentNode.replaceChild(newHeading, heading);
                }
            });
            
            return tempDiv.innerHTML;
        }
        
        // Centralized event management
        const EventManager = {
            listeners: new Map(),
            
            add(element, event, handler, options = {}) {
                const key = `${element}_${event}`;
                if (this.listeners.has(key)) {
                    element.removeEventListener(event, this.listeners.get(key));
                }
                
                element.addEventListener(event, handler, options);
                this.listeners.set(key, handler);
            },
            
            remove(element, event) {
                const key = `${element}_${event}`;
                if (this.listeners.has(key)) {
                    element.removeEventListener(event, this.listeners.get(key));
                    this.listeners.delete(key);
                }
            },
            
            removeAll() {
                this.listeners.clear();
            }
        };
        
        // Setup form validation with optimized event handling
        function setupFormValidation() {
            const inputs = DOM.customerForm.querySelectorAll('input, textarea');
            
            // Use event delegation for better performance
            EventManager.add(DOM.customerForm, 'focusout', (e) => {
                if (e.target.matches('input, textarea')) {
                    validateField(e.target);
                }
            });
            
            EventManager.add(DOM.customerForm, 'input', (e) => {
                if (e.target.matches('input, textarea')) {
                    clearFieldValidation(e.target);
                }
            });
        }
        
        // Validate individual field
        function validateField(field) {
            const value = field.value.trim();
            const fieldId = field.id;
            const feedback = document.getElementById(`${fieldId}-feedback`);
            
            let isValid = true;
            let message = '';
            
            // Required field validation
            if (field.required && !value) {
                isValid = false;
                message = 'This field is required';
            }
            
            // Email validation
            if (fieldId === 'customer-email' && value) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(value)) {
                    isValid = false;
                    message = 'Please enter a valid email address';
                }
            }
            
            // Phone validation (optional but if provided, should be valid)
            if (fieldId === 'customer-phone' && value) {
                const phoneRegex = /^[\d\s\-\+\(\)]{8,}$/;
                if (!phoneRegex.test(value)) {
                    isValid = false;
                    message = 'Please enter a valid phone number';
                }
            }
            
            // Update field appearance
            if (isValid) {
                field.classList.remove('is-invalid');
                field.classList.add('is-valid');
                if (feedback) {
                    feedback.textContent = '';
                    feedback.classList.remove('show');
                }
            } else {
                field.classList.remove('is-valid');
                field.classList.add('is-invalid');
                if (feedback) {
                    feedback.textContent = message;
                    feedback.classList.add('show');
                }
            }
            
            return isValid;
        }
        
        // Clear field validation
        function clearFieldValidation(field) {
            field.classList.remove('is-valid', 'is-invalid');
            const feedback = document.getElementById(`${field.id}-feedback`);
            if (feedback) {
                feedback.textContent = '';
                feedback.classList.remove('show');
            }
        }
        
        // Clear all form validation
        function clearFormValidation() {
            const form = document.getElementById('customer-form');
            const inputs = form.querySelectorAll('input, textarea');
            inputs.forEach(input => clearFieldValidation(input));
        }
        
        // Validate entire form
        function validateForm() {
            const inputs = DOM.customerForm.querySelectorAll('input[required], textarea[required]');
            let isValid = true;
            
            inputs.forEach(input => {
                if (!validateField(input)) {
                    isValid = false;
                }
            });
            
            return isValid;
        }
        
        // Initialize PayPal
        function initializePayPal() {
            if (typeof paypal === 'undefined') {
                document.getElementById('purchase-button-container').style.display = 'block';
                return;
            }
            
            // Clear any existing PayPal buttons
            const container = document.getElementById('paypal-button-container');
            container.innerHTML = '';
            
            paypal.Buttons({
                style: {
                    layout: 'vertical',
                    color: 'blue',
                    shape: 'rect',
                    label: 'pay',
                    height: 50
                },
                
                createOrder: function(data, actions) {
                    if (!selectedItem) {
                        showBootstrapAlert('Please select a voucher option before proceeding with payment.', 'Selection Required', 'warning');
                        return Promise.reject('No voucher selected');
                    }
                    
                    if (!validateForm()) {
                        // Get specific validation errors for better user experience
                        const nameValid = DOM.customerName.value.trim();
                        const emailValid = DOM.customerEmail.value.trim();
                        
                        let missingFields = [];
                        if (!nameValid) missingFields.push('Full Name');
                        if (!emailValid) missingFields.push('Email Address');
                        
                        const messageHtml = `
                            <p>Please complete the required fields:</p>
                            <ul class="text-start">
                                ${missingFields.map(field => `<li>${field} is required</li>`).join('')}
                            </ul>
                        `;
                        
                        showBootstrapAlertHtml(messageHtml, 'Required Information Missing', 'warning');
                        return Promise.reject('Form validation failed');
                    }
                    
                    const discountPercent = selectedItem.discount_percent || 0;
                    const originalPrice = parseFloat(selectedItem.value) || 0;
                    const discountedPrice = originalPrice * (1 - discountPercent / 100);
                    
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: discountedPrice.toFixed(2),
                                currency_code: 'AUD'
                            },
                            description: `${voucherType.display_name} - ${selectedItem.name}`,
                            soft_descriptor: 'URBAN JUNGLE IRC'
                        }]
                    });
                },
                
                onApprove: function(data, actions) {
                    const orderId = data.orderID;

                    // LAYER 0: Check if this PayPal order has already been processed
                    if (processedPayPalOrders.has(orderId)) {
                        console.warn('PayPal order already being processed, ignoring duplicate onApprove:', orderId);
                        showBootstrapAlert(
                            `This payment (${orderId}) is already being processed.\n\n` +
                            `Please do not refresh the page or click again.`,
                            'Processing in Progress',
                            'info'
                        );
                        return Promise.resolve(); // Resolve to prevent PayPal error
                    }

                    // Mark as processing immediately
                    processedPayPalOrders.add(orderId);

                    return actions.order.capture()
                        .then(function(details) {
                            // Update UI after PayPal capture is complete
                            container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><div class="mt-2">Processing voucher creation...</div></div>';

                            processPurchaseSuccess(details);
                        })
                        .catch(function(captureError) {
                            // Remove from Set on capture failure (allow retry)
                            processedPayPalOrders.delete(orderId);

                            showBootstrapAlert('Payment capture failed. Please contact support if you were charged.', 'Capture Error', 'error');
                            initializePayPal();
                        });
                },
                
                onError: function(err) {
                    console.log('PayPal Error:', err);
                    // Only show generic error for actual PayPal errors, not validation failures
                    if (err && !err.toString().includes('validation') && !err.toString().includes('selected')) {
                        showBootstrapAlert('Payment processing failed. Please try again or contact support if the problem persists.', 'Payment Error', 'error');
                    }
                    // Always reinitialize PayPal buttons for responsiveness
                    setTimeout(() => {
                        initializePayPal();
                    }, 100);
                },
                
                onCancel: function(data) {
                    // Reinitialize PayPal buttons
                    initializePayPal();
                }
            }).render('#paypal-button-container');
        }

        // Show processing spinner with dynamic messaging for retry attempts
        function showProcessingSpinner(retryCount = 0, maxRetries = 0) {
            if (DOM.processingSpinner) {
                DOM.processingSpinner.style.display = 'flex';

                const messageEl = DOM.processingSpinner.querySelector('h4');
                const subMessageEl = DOM.processingSpinner.querySelector('p') ||
                                    createSubMessage(messageEl);

                if (retryCount === 0) {
                    messageEl.textContent = 'Processing Payment...';
                    subMessageEl.textContent = 'This may take up to 60 seconds. Please wait.';
                } else if (retryCount === 1) {
                    messageEl.textContent = 'Still Processing...';
                    subMessageEl.textContent = `Payment confirmed. Creating your voucher. Attempt ${retryCount + 1} of ${maxRetries + 1}...`;
                } else {
                    messageEl.textContent = 'Almost There...';
                    subMessageEl.textContent = `Your voucher is being prepared. Final attempt...`;
                }
            }
        }

        // Helper to create sub-message element if it doesn't exist
        function createSubMessage(afterElement) {
            const p = document.createElement('p');
            p.className = 'text-muted mb-0';
            afterElement.parentNode.insertBefore(p, afterElement.nextSibling);
            return p;
        }

        // Hide processing spinner
        function hideProcessingSpinner() {
            if (DOM.processingSpinner) {
                DOM.processingSpinner.style.display = 'none';
            }
        }

        // Make API request with retry logic
        async function makeRetryableRequest(apiUrl, paymentDetails, retryCount = 0) {
            const maxRetries = PURCHASE_CONFIG.MAX_RETRIES;
            const timeout = retryCount === 0
                ? PURCHASE_CONFIG.INITIAL_TIMEOUT
                : PURCHASE_CONFIG.RETRY_TIMEOUTS[retryCount - 1] || PURCHASE_CONFIG.RETRY_TIMEOUTS[PURCHASE_CONFIG.RETRY_TIMEOUTS.length - 1];

            showProcessingSpinner(retryCount, maxRetries);

            try {
                const result = await ApiClient.makeRequest(apiUrl, { timeout });
                return { success: true, data: result };

            } catch (error) {
                console.warn(`Attempt ${retryCount + 1} failed:`, error.message);

                // If we have retries left and it's a timeout, retry
                if (retryCount < maxRetries && error.message.includes('timed out')) {
                    await new Promise(resolve => setTimeout(resolve, PURCHASE_CONFIG.RETRY_DELAY));
                    return makeRetryableRequest(apiUrl, paymentDetails, retryCount + 1);
                }

                return { success: false, error, exhaustedRetries: retryCount >= maxRetries };
            }
        }

        // Process purchase success with retry logic and idempotency
        async function processPurchaseSuccess(paymentDetails) {
            const orderId = paymentDetails.id || paymentDetails.orderID;

            // LAYER 1: Set processing flag IMMEDIATELY (eliminate race condition)
            if (window.isProcessingPurchase) {
                console.warn('Purchase already being processed, ignoring duplicate call');
                return;
            }
            window.isProcessingPurchase = true;

            // LAYER 2: Check localStorage for duplicate (page refresh protection)
            if (OrderStorage.exists(orderId)) {
                console.warn('Order already processed or in progress:', orderId);
                window.isProcessingPurchase = false; // Reset flag
                showBootstrapAlert(
                    `This order (${orderId}) has already been submitted.\n\n` +
                    `Please check your email for the voucher, or contact support if you need assistance.`,
                    'Order Already Submitted',
                    'info'
                );
                return;
            }

            // Save to localStorage immediately
            const customerEmail = DOM.customerEmail.value.trim();
            OrderStorage.save({
                orderId,
                email: customerEmail,
                status: 'processing',
                retryCount: 0
            });

            showProcessingSpinner(0, PURCHASE_CONFIG.MAX_RETRIES);

            // Prepare customer data
            const customerData = {
                name: DOM.customerName.value.trim(),
                email: customerEmail,
                giftRecipient: DOM.giftRecipient.value.trim(),
                giftFrom: DOM.giftFrom.value.trim(),
                giftMessage: DOM.giftMessage.value.trim()
            };

            // Create essential purchase data
            const essentialData = {
                voucherType: {
                    type_id: voucherType.type_id,
                    promo_id: voucherType.promo_id
                },
                voucherItem: {
                    id: selectedItem.id,
                    name: selectedItem.name,
                    value: selectedItem.value
                },
                customer: {
                    name: customerData.name,
                    email: customerData.email,
                    gift_recipient: customerData.giftRecipient,
                    gift_from: customerData.giftFrom,
                    gift_message: customerData.giftMessage
                },
                payment: {
                    id: orderId,
                    orderID: orderId
                },
                promoId: new URLSearchParams(window.location.search).get('promoID')
            };

            const encodedData = encodeURIComponent(JSON.stringify(essentialData));
            const apiUrl = `${CONFIG.API_BASE_URL}?action=processCustomerPurchase&data=${encodedData}`;

            // Make request with retry logic
            const result = await makeRetryableRequest(apiUrl, paymentDetails);

            window.isProcessingPurchase = false;
            hideProcessingSpinner();

            // Handle result
            if (result.success && result.data) {
                OrderStorage.clear();
                processedPayPalOrders.delete(orderId); // Clean up memory
                handlePurchaseSuccess(result.data);

            } else if (result.exhaustedRetries) {
                // All retries exhausted - show optimistic success
                OrderStorage.save({
                    orderId,
                    email: customerEmail,
                    status: 'pending_confirmation'
                });

                processedPayPalOrders.delete(orderId); // Clean up memory
                handleOptimisticSuccess(orderId, customerEmail);

            } else {
                // Genuine error (not timeout)
                OrderStorage.clear();
                processedPayPalOrders.delete(orderId); // Clean up memory (allow retry)
                handlePurchaseError(result.error);
            }
        }

        // Handle optimistic success (when retries are exhausted but payment succeeded)
        function handleOptimisticSuccess(orderId, email) {
            DOM.voucherContent.style.display = 'none';
            DOM.successMessage.style.display = 'block';
            DOM.successEmail.textContent = email;

            // Update success message with order ID
            const successMessageEl = DOM.successMessage;
            successMessageEl.innerHTML = `
                <h4><i class="bi bi-check-circle"></i> Payment Received!</h4>
                <p>
                    Thank you for your payment! Your voucher is being created and will be sent to
                    <strong>${email}</strong> within <strong>15 minutes</strong>.
                </p>
                <div class="alert alert-info mt-3">
                    <p class="mb-2"><strong>Order ID:</strong> <code>${orderId}</code></p>
                    <p class="mb-0">
                        <small>
                            If you don't receive your voucher within 15 minutes, please contact us at
                            <strong>frontdesk@urbanjungleirc.com</strong> or <strong>(08) 6397 0411</strong>
                            with your order ID.
                        </small>
                    </p>
                </div>
            `;

            // Track conversion (payment succeeded)
            if (typeof gtag !== 'undefined') {
                gtag('event', 'purchase', {
                    'transaction_id': orderId,
                    'value': selectedItem.value,
                    'currency': 'AUD',
                    'items': [{
                        'item_id': selectedItem.id,
                        'item_name': selectedItem.name,
                        'category': voucherType.display_name,
                        'price': selectedItem.value,
                        'quantity': 1
                    }]
                });
            }

            if (typeof fbq !== 'undefined') {
                fbq('track', 'Purchase', {
                    value: selectedItem.value,
                    currency: 'AUD'
                });
            }

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Handle purchase success
        function handlePurchaseSuccess(result) {
            if (result && result.success) {
                // Hide voucher content
                DOM.voucherContent.style.display = 'none';
                
                // Show success message
                DOM.successMessage.style.display = 'block';
                DOM.successEmail.textContent = DOM.customerEmail.value;
                
                // Track conversion
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'purchase', {
                        'transaction_id': result.voucherId,
                        'value': selectedItem.value,
                        'currency': 'AUD',
                        'items': [{
                            'item_id': selectedItem.id,
                            'item_name': selectedItem.name,
                            'category': voucherType.display_name,
                            'price': selectedItem.value,
                            'quantity': 1
                        }]
                    });
                }
                
                // Facebook Pixel conversion tracking
                if (typeof fbq !== 'undefined') {
                    fbq('track', 'Purchase', {
                        value: selectedItem.value,
                        currency: 'AUD'
                    });
                }
                
                // Scroll to success message
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
            } else {
                handlePurchaseError(result ? result.error : 'Purchase processing failed');
            }
        }
        
        // Handle purchase error
        function handlePurchaseError(error) {
            const errorString = error.toString().toLowerCase();
            const isTimeout = errorString.includes('timeout') || errorString.includes('timed out');

            if (isTimeout) {
                // Shouldn't happen with retry logic, but provide safety net
                showBootstrapAlert(
                    'Your payment was processed but voucher creation is taking longer than expected.\n\n' +
                    'Your voucher will be sent to your email within 15 minutes.\n\n' +
                    'If you don\'t receive it, please contact support at frontdesk@urbanjungleirc.com or (08) 6397 0411.',
                    'Processing Delayed',
                    'warning'
                );
                return;
            }

            // Check if purchase limit error
            const isPurchaseLimitError = errorString.includes('purchase limit') ||
                                           errorString.includes('limit reached') ||
                                           errorString.includes('maximum') ||
                                           errorString.includes('per customer');

            if (isPurchaseLimitError) {
                showBootstrapAlert(
                    error + '\n\nThis is a promotional limit to ensure fair access for all customers.',
                    'Purchase Limit Reached',
                    'warning'
                );
            } else {
                showBootstrapAlert(
                    'Purchase processing failed: ' + error + '\n\nPlease contact us at frontdesk@urbanjungleirc.com or (08) 6397 0411 for assistance.',
                    'Purchase Failed',
                    'error'
                );
            }

            initializePayPal();
        }
        
        // Enhanced loading experience with multi-stage animation designed to mitigate GAS delays
        function showLoading() {
            DOM.loadingSpinner.style.display = 'block';
            DOM.errorMessage.style.display = 'none';
            DOM.voucherContent.style.display = 'none';
            
            // Start engaging loading animation
            startLoadingAnimation();
        }
        
        // Optimized loading animation with better performance
        let loadingAnimationId = null;
        let loadingCancelled = false;
        
        function startLoadingAnimation() {
            const progressBar = document.getElementById('loading-progress');
            const loadingStage = document.getElementById('loading-stage');
            
            if (!progressBar || !loadingStage) return;
            
            loadingCancelled = false;
            let currentStage = 0;
            let progress = 0;
            const startTime = Date.now();
            
            const stages = [
                { progress: 20, message: 'üîç Loading your adventure options...', duration: 1000 },
                { progress: 50, message: 'üí∞ Calculating prices...', duration: 800 },
                { progress: 80, message: 'üéÅ Preparing vouchers...', duration: 600 },
                { progress: 95, message: '‚ú® Almost ready...', duration: 400 }
            ];
            
            function animate() {
                if (loadingCancelled) return;
                
                const elapsed = Date.now() - startTime;
                const targetStage = stages.find(s => elapsed < s.duration * (stages.indexOf(s) + 1)) || stages[stages.length - 1];
                
                // Smooth progress interpolation
                const targetProgress = targetStage.progress;
                progress += (targetProgress - progress) * 0.1;
                
                progressBar.style.width = Math.min(95, progress) + '%';
                
                // Update message when stage changes
                const stageIndex = stages.indexOf(targetStage);
                if (stageIndex !== currentStage && stageIndex >= 0) {
                    currentStage = stageIndex;
                    loadingStage.innerHTML = `<p class="mb-2 fw-bold">${targetStage.message}</p>`;
                }
                
                // Continue animation if not at final stage
                if (progress < 95 && !loadingCancelled) {
                    loadingAnimationId = requestAnimationFrame(animate);
                }
            }
            
            loadingAnimationId = requestAnimationFrame(animate);
        }
        
        // Cancel loading animation
        function stopLoadingAnimation() {
            loadingCancelled = true;
            if (loadingAnimationId) {
                cancelAnimationFrame(loadingAnimationId);
                loadingAnimationId = null;
            }
        }
        
        // Hide loading state
        function hideLoading() {
            stopLoadingAnimation();
            DOM.loadingSpinner.style.display = 'none';
        }
        
        // Show error message
        function showError(message) {
            document.getElementById('error-text').textContent = message;
            DOM.errorMessage.style.display = 'block';
            DOM.loadingSpinner.style.display = 'none';
            DOM.voucherContent.style.display = 'none';
        }
        
        // Show error message with HTML formatting
        function showErrorHtml(htmlContent) {
            document.getElementById('error-text').innerHTML = htmlContent;
            DOM.errorMessage.style.display = 'block';
            DOM.loadingSpinner.style.display = 'none';
            DOM.voucherContent.style.display = 'none';
        }
        
        // Show PayPal error (fallback)
        function showPayPalError() {
            showBootstrapAlert(
                'PayPal payment processing is not available. Please contact us directly at frontdesk@urbanjungleirc.com or (08) 6397 0411 to purchase vouchers.',
                'Payment System Unavailable',
                'error'
            );
        }
        
        // Setup additional event listeners
        function setupEventListeners() {
            const ctaButton = document.querySelector('.hero-cta');
            if (ctaButton) {
                EventManager.add(ctaButton, 'click', function(e) {
                    e.preventDefault();
                    const target = document.querySelector('#voucher-selection');
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            }
        }

        // ============ TEST MODE FUNCTIONS ============
        // Activate test mode by adding ?test=true to URL

        // Check if test mode should be enabled
        function checkTestMode() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('test') === 'true') {
                document.getElementById('test-mode-panel').style.display = 'block';
                console.log('%cüß™ TEST MODE ACTIVATED', 'color: #ff6b6b; font-size: 16px; font-weight: bold;');
                console.log('Test panel visible at bottom-right corner');
            }
        }

        // Create mock payment details
        function createMockPaymentDetails(orderId = null) {
            const mockOrderId = orderId || 'TEST_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            return {
                id: mockOrderId,
                orderID: mockOrderId,
                status: 'COMPLETED',
                payer: {
                    email_address: 'test@example.com',
                    name: { given_name: 'Test', surname: 'User' }
                }
            };
        }

        // Test 1: Simulate duplicate click (same order ID twice)
        window.testDuplicatePrevention = function() {
            const testResults = document.getElementById('test-results');
            testResults.innerHTML = '<strong>Running Test 1...</strong><br/>';

            const mockDetails = createMockPaymentDetails();
            const orderId = mockDetails.orderID;

            console.log('%c[TEST 1] Simulating duplicate onApprove with same order ID', 'color: #ff6b6b; font-weight: bold;');
            console.log('Order ID:', orderId);

            // Simulate onApprove being called
            const mockData = { orderID: orderId };
            const mockActions = {
                order: {
                    capture: () => Promise.resolve(mockDetails)
                }
            };

            // First call
            console.log('‚ñ∂Ô∏è First call...');
            testResults.innerHTML += '1st call: Processing...<br/>';

            // Check if already in Set
            if (processedPayPalOrders.has(orderId)) {
                testResults.innerHTML += '<span style="color:red;">‚ùå FAILED: Order already in Set before first call!</span><br/>';
                console.error('Order already in Set!');
                return;
            }

            processedPayPalOrders.add(orderId);
            testResults.innerHTML += '<span style="color:green;">‚úÖ Added to Set</span><br/>';

            // Second call (should be blocked)
            console.log('‚ñ∂Ô∏è Second call (should be blocked)...');
            testResults.innerHTML += '2nd call: ';

            if (processedPayPalOrders.has(orderId)) {
                testResults.innerHTML += '<span style="color:green;">‚úÖ BLOCKED (Layer 0 working!)</span><br/>';
                console.log('%c‚úÖ SUCCESS: Duplicate blocked by Layer 0 (Set)', 'color: green; font-weight: bold;');
            } else {
                testResults.innerHTML += '<span style="color:red;">‚ùå NOT BLOCKED (Layer 0 failed!)</span><br/>';
                console.error('‚ùå FAILED: Duplicate not blocked!');
            }
        };

        // Test 2: Simulate rapid clicks (3 clicks in quick succession)
        window.testRapidClicks = async function() {
            const testResults = document.getElementById('test-results');
            testResults.innerHTML = '<strong>Running Test 2...</strong><br/>';

            const mockDetails = createMockPaymentDetails();
            const orderId = mockDetails.orderID;

            console.log('%c[TEST 2] Simulating rapid clicks', 'color: #ff6b6b; font-weight: bold;');
            console.log('Order ID:', orderId);

            let blocked = 0;
            let processed = 0;

            for (let i = 1; i <= 3; i++) {
                if (processedPayPalOrders.has(orderId)) {
                    blocked++;
                    testResults.innerHTML += `Click ${i}: <span style="color:green;">‚úÖ BLOCKED</span><br/>`;
                    console.log(`Click ${i}: Blocked ‚úÖ`);
                } else {
                    processed++;
                    processedPayPalOrders.add(orderId);
                    testResults.innerHTML += `Click ${i}: <span style="color:orange;">‚ö†Ô∏è PROCESSED</span><br/>`;
                    console.log(`Click ${i}: Processed ‚ö†Ô∏è`);
                }
                await new Promise(resolve => setTimeout(resolve, 10));
            }

            testResults.innerHTML += `<br/><strong>Result: ${processed} processed, ${blocked} blocked</strong><br/>`;

            if (processed === 1 && blocked === 2) {
                testResults.innerHTML += '<span style="color:green;">‚úÖ PASS: Only 1 processed, 2 blocked</span>';
                console.log('%c‚úÖ TEST PASSED', 'color: green; font-weight: bold;');
            } else {
                testResults.innerHTML += '<span style="color:red;">‚ùå FAIL: Expected 1 processed, 2 blocked</span>';
                console.error('‚ùå TEST FAILED');
            }
        };

        // Test 3: Test localStorage check
        window.testLocalStorageCheck = function() {
            const testResults = document.getElementById('test-results');
            testResults.innerHTML = '<strong>Running Test 3...</strong><br/>';

            const mockOrderId = 'TEST_LOCALSTORAGE_' + Date.now();

            console.log('%c[TEST 3] Testing localStorage duplicate check', 'color: #ff6b6b; font-weight: bold;');
            console.log('Order ID:', mockOrderId);

            // Save to localStorage
            OrderStorage.save({
                orderId: mockOrderId,
                email: 'test@example.com',
                status: 'processing',
                retryCount: 0
            });

            testResults.innerHTML += 'Saved to localStorage...<br/>';

            // Check if exists
            if (OrderStorage.exists(mockOrderId)) {
                testResults.innerHTML += '<span style="color:green;">‚úÖ PASS: localStorage check working (Layer 2)</span><br/>';
                console.log('%c‚úÖ TEST PASSED', 'color: green; font-weight: bold;');
            } else {
                testResults.innerHTML += '<span style="color:red;">‚ùå FAIL: localStorage check not working</span><br/>';
                console.error('‚ùå TEST FAILED');
            }

            // Try to check with different order ID
            if (!OrderStorage.exists('DIFFERENT_ORDER_ID')) {
                testResults.innerHTML += '<span style="color:green;">‚úÖ PASS: Different order ID correctly returns false</span>';
                console.log('‚úÖ Different order ID correctly rejected');
            } else {
                testResults.innerHTML += '<span style="color:red;">‚ùå FAIL: Different order ID incorrectly matched</span>';
                console.error('‚ùå Different order ID incorrectly matched');
            }
        };

        // Clear test state
        window.clearTestState = function() {
            const testResults = document.getElementById('test-results');
            testResults.innerHTML = 'Clearing test state...<br/>';

            // Clear Set
            const setSize = processedPayPalOrders.size;
            processedPayPalOrders.clear();
            testResults.innerHTML += `Cleared ${setSize} items from Set<br/>`;

            // Clear localStorage
            OrderStorage.clear();
            testResults.innerHTML += 'Cleared localStorage<br/>';

            // Clear flags
            window.isProcessingPurchase = false;
            testResults.innerHTML += '<span style="color:green;">‚úÖ All test state cleared</span>';

            console.log('%c‚úÖ Test state cleared', 'color: green; font-weight: bold;');
        };

        // Enable test mode on page load if ?test=true
        document.addEventListener('DOMContentLoaded', function() {
            checkTestMode();
        });

    </script>
</body>
</html>